<%- include('partials/adminHeader') %>

<!-- Quill.js WYSIWYG Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
.ql-container {
    font-family: 'Fira Code', 'Roboto Mono', monospace;
    font-size: 14px;
    background: #161b22;
    color: #c9d1d9;
    min-height: 400px;
}

.ql-editor {
    min-height: 400px;
}

.ql-toolbar {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: 4px 4px 0 0;
}

.ql-container {
    border: 1px solid #21262d;
    border-top: none;
    border-radius: 0 0 4px 4px;
}

.ql-stroke {
    stroke: #c9d1d9;
}

.ql-fill {
    fill: #c9d1d9;
}

.ql-picker-label {
    color: #c9d1d9;
}

.ql-snow .ql-picker.ql-expanded .ql-picker-label {
    color: #c9d1d9;
}

.ql-snow .ql-picker-options {
    background: #0d1117;
    border: 1px solid #21262d;
}

.ql-snow .ql-picker-item {
    color: #c9d1d9;
}

.ql-snow .ql-picker-item:hover {
    background: #161b22;
    color: #00ff99;
}

.ql-snow button:hover,
.ql-snow button:focus,
.ql-snow button.ql-active,
.ql-snow .ql-picker-label:hover,
.ql-snow .ql-picker-label.ql-active {
    color: #00ff99;
}

.ql-snow button:hover .ql-stroke,
.ql-snow button:focus .ql-stroke,
.ql-snow button.ql-active .ql-stroke,
.ql-snow .ql-picker-label:hover .ql-stroke,
.ql-snow .ql-picker-label.ql-active .ql-stroke {
    stroke: #00ff99;
}

.ql-snow button:hover .ql-fill,
.ql-snow button:focus .ql-fill,
.ql-snow button.ql-active .ql-fill,
.ql-snow .ql-picker-label:hover .ql-fill,
.ql-snow .ql-picker-label.ql-active .ql-fill {
    fill: #00ff99;
}

#editor-container {
    margin-bottom: 1rem;
}
</style>

<div class="form-container">
    <h2><%= post ? 'Edit Post' : 'Create New Post' %></h2>
    
    <form method="POST" action="<%= post ? `/admin/posts/${post.id}?_method=PUT` : '/admin/posts' %>" enctype="multipart/form-data" class="edit-form">
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="<%= post ? post.title : '' %>" required>
        </div>
        
        <div class="form-group">
            <label for="excerpt">Excerpt</label>
            <textarea id="excerpt" name="excerpt" rows="2"><%= post ? post.excerpt : '' %></textarea>
        </div>
        
        <div class="form-group">
            <label for="featuredImage">Featured Image</label>
            <% if (post && post.featuredImage) { %>
                <div style="margin-bottom: 1rem;">
                    <img src="<%= post.featuredImage %>" alt="Featured image" style="max-width: 300px; border-radius: 4px; border: 2px solid #21262d;">
                </div>
            <% } %>
            <input type="file" id="featuredImage" name="featuredImage" accept="image/*">
            <small style="color: #8b949e; display: block; margin-top: 0.5rem;">This image will be displayed in the blog list</small>
        </div>
        
        <div class="form-group">
            <label for="content">Content</label>
            <textarea id="content" name="content" required style="display: none;"><%= post ? post.content : '' %></textarea>
            <div id="editor-container"></div>
        </div>
        
        <div class="form-group">
            <label for="published" class="checkbox-label">
                <input type="checkbox" id="published" name="published" <%= post && post.published ? 'checked' : '' %>>
                Publish Post
            </label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><%= post ? 'Update' : 'Create' %> Post</button>
            <a href="/admin/posts" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image', 'code-block'],
                ['clean']
            ]
        },
        placeholder: 'Start writing your post...'
    });

    // Загружаем существующий контент
    var contentTextarea = document.querySelector('#content');
    if (contentTextarea && contentTextarea.value) {
        quill.root.innerHTML = contentTextarea.value;
    }

    // Обработчик загрузки изображений
    var toolbar = quill.getModule('toolbar');
    toolbar.addHandler('image', function() {
        var input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = function() {
            var file = this.files[0];
            if (file) {
                var formData = new FormData();
                formData.append('file', file);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/admin/posts/upload-image', true);

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var range = quill.getSelection(true);
                        quill.insertEmbed(range.index, 'image', response.location);
                        quill.setSelection(range.index + 1);
                    } else {
                        alert('Error uploading image');
                    }
                };

                xhr.send(formData);
            }
        };
    });

    // Сохраняем контент в textarea перед отправкой формы
    var form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            contentTextarea.value = quill.root.innerHTML;
        });
    }
});
</script>

<%- include('partials/adminFooter') %>



