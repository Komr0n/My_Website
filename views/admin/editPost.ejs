<%- include('partials/adminHeader') %>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style nonce="<%= cspNonce %>">
.ql-container {
    font-family: 'Fira Code', 'Roboto Mono', monospace;
    font-size: 14px;
    background: #161b22;
    color: #c9d1d9;
    min-height: 220px;
}

.ql-editor {
    min-height: 220px;
}

.ql-toolbar {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: 4px 4px 0 0;
}

.ql-container {
    border: 1px solid #21262d;
    border-top: none;
    border-radius: 0 0 4px 4px;
}

.ql-stroke {
    stroke: #c9d1d9;
}

.ql-fill {
    fill: #c9d1d9;
}

.ql-picker-label {
    color: #c9d1d9;
}

.ql-snow .ql-picker.ql-expanded .ql-picker-label {
    color: #c9d1d9;
}

.ql-snow .ql-picker-options {
    background: #0d1117;
    border: 1px solid #21262d;
}

.ql-snow .ql-picker-item {
    color: #c9d1d9;
}

.ql-snow .ql-picker-item:hover {
    background: #161b22;
    color: #00ff99;
}

.ql-snow button:hover,
.ql-snow button:focus,
.ql-snow button.ql-active,
.ql-snow .ql-picker-label:hover,
.ql-snow .ql-picker-label.ql-active {
    color: #00ff99;
}

.ql-snow button:hover .ql-stroke,
.ql-snow button:focus .ql-stroke,
.ql-snow button.ql-active .ql-stroke,
.ql-snow .ql-picker-label:hover .ql-stroke,
.ql-snow .ql-picker-label.ql-active .ql-stroke {
    stroke: #00ff99;
}

.ql-snow button:hover .ql-fill,
.ql-snow button:focus .ql-fill,
.ql-snow button.ql-active .ql-fill,
.ql-snow .ql-picker-label:hover .ql-fill,
.ql-snow .ql-picker-label.ql-active .ql-fill {
    fill: #00ff99;
}

.editor-container {
    margin-bottom: 1rem;
}

.post-section {
    border: 1px solid #21262d;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    background: #0f141b;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.section-header h3 {
    color: #00ff99;
    margin: 0;
    font-size: 1.1rem;
}

.media-library {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #21262d;
}

.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.media-item {
    border: 1px solid #21262d;
    border-radius: 6px;
    overflow: hidden;
    background: #0d1117;
}

.media-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
}

.media-item-footer {
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    justify-content: space-between;
    align-items: center;
}

.media-url {
    font-size: 0.8rem;
    color: #8b949e;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 110px;
}
</style>

<div class="form-container">
    <h2><%= post ? 'Edit Post' : 'Create New Post' %></h2>

    <% const coverPreview = post && (post.coverImage || post.featuredImage) ? (post.coverImage || post.featuredImage) : null; %>
    <% const publishedValue = post && post.publishedAt ? new Date(post.publishedAt).toISOString().slice(0, 16) : ''; %>

    <form method="POST" action="<%= post ? `/admin/posts/${post.id}?_method=PUT` : '/admin/posts' %>" enctype="multipart/form-data" class="edit-form">
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="<%= post ? post.title : '' %>" required>
        </div>

        <div class="form-group">
            <label for="subtitle">Subtitle (optional)</label>
            <input type="text" id="subtitle" name="subtitle" value="<%= post ? post.subtitle : '' %>">
        </div>

        <div class="form-group">
            <label for="excerpt">Excerpt (optional)</label>
            <textarea id="excerpt" name="excerpt" rows="2"><%= post ? post.excerpt : '' %></textarea>
        </div>

        <div class="form-group">
            <label for="coverImage">Cover Image (required)</label>
            <% if (coverPreview) { %>
                <div style="margin-bottom: 1rem;">
                    <img src="<%= coverPreview %>" alt="Cover image" style="max-width: 300px; border-radius: 4px; border: 2px solid #21262d;">
                </div>
            <% } %>
            <input type="file" id="coverImage" name="coverImage" accept="image/*" <%= coverPreview ? '' : 'required' %>>
            <small style="color: #8b949e; display: block; margin-top: 0.5rem;">Shown on the blog list and post header.</small>
        </div>

        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="draft" <%= !post || post.status === 'draft' ? 'selected' : '' %>>Draft</option>
                <option value="scheduled" <%= post && post.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
                <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>Published</option>
            </select>
        </div>

        <div class="form-group">
            <label for="publishedAt">Publish Date & Time</label>
            <input type="datetime-local" id="publishedAt" name="publishedAt" value="<%= publishedValue %>">
            <small style="color: #8b949e; display: block; margin-top: 0.5rem;">For Scheduled status this must be a future date/time.</small>
        </div>

        <div class="form-group">
            <label>Post Sections</label>
            <div id="sections-container">
                <% sections.forEach((section, index) => { %>
                    <div class="post-section" data-index="<%= index %>">
                        <div class="section-header">
                            <h3>Section <%= index + 1 %></h3>
                            <% if (index > 0) { %>
                                <button type="button" class="btn btn-small btn-secondary remove-section">Remove</button>
                            <% } %>
                        </div>
                        <div class="form-group">
                            <label>Section Title (optional)</label>
                            <input type="text" class="section-title" value="<%= section.title || '' %>">
                        </div>
                        <div class="form-group">
                            <label>Section Content</label>
                            <textarea class="section-content" style="display: none;"><%- section.content || '' %></textarea>
                            <div class="editor-container"></div>
                        </div>
                    </div>
                <% }); %>
            </div>
            <button type="button" class="btn btn-secondary" id="add-section">+ Add Section</button>
            <input type="hidden" name="sections" id="sections-json">
            <div class="form-group" id="fallback-container" style="margin-top: 1rem;">
                <label for="fallbackContent">First Section Content (required)</label>
                <textarea id="fallbackContent" name="fallbackContent" rows="8"><%- sections[0] ? sections[0].content : '' %></textarea>
                <small style="color: #8b949e; display: block; margin-top: 0.5rem;">
                    If the editor fails to load, use this field. It will be hidden when the editor is active.
                </small>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><%= post ? 'Update' : 'Create' %> Post</button>
            <a href="/admin/posts" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

    <div class="media-library">
        <h3>Media Library</h3>
        <p style="color: #8b949e;">Upload images in <a href="/admin/media">Media Library</a>. Click Insert to place an image in the active section.</p>
        <% if (media && media.length > 0) { %>
            <div class="media-grid">
                <% media.forEach(item => { %>
                    <div class="media-item">
                        <img src="<%= item.url %>" alt="<%= item.originalName %>">
                        <div class="media-item-footer">
                            <span class="media-url"><%= item.originalName %></span>
                            <button type="button" class="btn btn-small media-insert" data-url="<%= item.url %>">Insert</button>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <p style="color: #8b949e;">No media yet.</p>
        <% } %>
    </div>
</div>

<script nonce="<%= cspNonce %>">
document.addEventListener('DOMContentLoaded', function() {
    var editors = [];
    var activeEditor = null;
    var quillAvailable = typeof Quill === 'function';

    function createToolbar() {
        return [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link', 'image', 'code-block'],
            ['clean']
        ];
    }

    function uploadImage(file, quill) {
        var formData = new FormData();
        formData.append('file', file);

        fetch('/admin/posts/upload-image', {
            method: 'POST',
            body: formData
        }).then(function(response) {
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            return response.json();
        }).then(function(data) {
            var range = quill.getSelection(true) || { index: quill.getLength() };
            quill.insertEmbed(range.index, 'image', data.location);
            quill.setSelection(range.index + 1);
        }).catch(function() {
            alert('Error uploading image');
        });
    }

    function initEditor(sectionEl) {
        var editorEl = sectionEl.querySelector('.editor-container');
        var contentEl = sectionEl.querySelector('.section-content');
        var quill = new Quill(editorEl, {
            theme: 'snow',
            modules: {
                toolbar: createToolbar()
            },
            placeholder: 'Write your section...'
        });

        if (contentEl && contentEl.value) {
            quill.root.innerHTML = contentEl.value;
        }

        quill.on('selection-change', function(range) {
            if (range) {
                activeEditor = quill;
            }
        });

        var toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', function() {
            var input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            input.onchange = function() {
                var file = this.files[0];
                if (file) {
                    uploadImage(file, quill);
                }
            };
        });

        editors.push({ element: sectionEl, quill: quill });
    }

    if (quillAvailable) {
        document.querySelectorAll('.post-section').forEach(function(sectionEl) {
            initEditor(sectionEl);
        });
    }

    var fallbackBox = document.getElementById('fallback-container');
    var fallbackInput = document.getElementById('fallbackContent');
    if (editors.length > 0 && fallbackBox) {
        fallbackBox.style.display = 'none';
    }
    if (fallbackInput) {
        fallbackInput.required = !quillAvailable;
    }

    document.getElementById('add-section').addEventListener('click', function() {
        if (!quillAvailable) {
            alert('Editor is unavailable. Use the fallback content field below.');
            return;
        }
        var container = document.getElementById('sections-container');
        var index = container.children.length;
        var wrapper = document.createElement('div');
        wrapper.className = 'post-section';
        wrapper.setAttribute('data-index', index);
        wrapper.innerHTML = `
            <div class="section-header">
                <h3>Section ${index + 1}</h3>
                <button type="button" class="btn btn-small btn-secondary remove-section">Remove</button>
            </div>
            <div class="form-group">
                <label>Section Title (optional)</label>
                <input type="text" class="section-title" value="">
            </div>
            <div class="form-group">
                <label>Section Content</label>
                <textarea class="section-content" style="display: none;"></textarea>
                <div class="editor-container"></div>
            </div>
        `;
        container.appendChild(wrapper);
        initEditor(wrapper);
    });

    document.getElementById('sections-container').addEventListener('click', function(event) {
        if (!event.target.classList.contains('remove-section')) {
            return;
        }
        var section = event.target.closest('.post-section');
        if (section) {
            section.remove();
            editors = editors.filter(function(entry) {
                return entry.element !== section;
            });
        }
    });

    document.querySelectorAll('.media-insert').forEach(function(button) {
        button.addEventListener('click', function() {
            if (!activeEditor) {
                alert('Click inside a section before inserting an image.');
                return;
            }
            var url = button.getAttribute('data-url');
            var range = activeEditor.getSelection(true) || { index: activeEditor.getLength() };
            activeEditor.insertEmbed(range.index, 'image', url);
            activeEditor.setSelection(range.index + 1);
        });
    });

    var form = document.querySelector('form.edit-form');
    if (!form) {
        return;
    }
    form.addEventListener('submit', function() {
        var sections = [];
        document.querySelectorAll('.post-section').forEach(function(sectionEl) {
            var title = sectionEl.querySelector('.section-title').value.trim();
            var editorEntry = editors.find(function(entry) {
                return entry.element === sectionEl;
            });
            var content = editorEntry ? editorEntry.quill.root.innerHTML : '';
            var cleaned = content.replace(/<p><br><\/p>/g, '').trim();
            if (title || cleaned) {
                sections.push({ title: title, content: content });
            }
        });
        var fallback = document.getElementById('fallbackContent');
        if (!sections.length && fallback && fallback.value.trim()) {
            sections.push({ title: '', content: fallback.value });
        }
        if (sections.length && fallback) {
            fallback.value = sections[0].content || fallback.value;
        }
        document.getElementById('sections-json').value = JSON.stringify(sections);
    });
});
</script>

<%- include('partials/adminFooter') %>
